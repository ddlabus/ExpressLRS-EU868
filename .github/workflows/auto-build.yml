name: Auto Build on ELRS Release

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  UPSTREAM_REPO: ExpressLRS/ExpressLRS
  REGULATORY_DOMAIN: -DRegulatory_Domain_EU_868
  MODULE_NAME: E32-900M30S
  BAND_NAME: EU868

jobs:
  check-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest ELRS release
        id: elrs_release
        run: |
          RELEASE_DATA=$(curl -s https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest)
          TAG=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
          PUBLISHED=$(echo "$RELEASE_DATA" | jq -r '.published_at')
          PRERELEASE=$(echo "$RELEASE_DATA" | jq -r '.prerelease')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "published=$PUBLISHED" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

      - name: Check if stable and older than 7 days
        id: check_age
        run: |
          if [ "${{ steps.elrs_release.outputs.prerelease }}" == "true" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          PUBLISHED="${{ steps.elrs_release.outputs.published }}"
          PUBLISHED_TS=$(date -d "$PUBLISHED" +%s)
          NOW_TS=$(date +%s)
          AGE_DAYS=$(( (NOW_TS - PUBLISHED_TS) / 86400 ))
          if [ $AGE_DAYS -lt 7 ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if already built
        id: check_built
        if: steps.check_age.outputs.should_build == 'true'
        run: |
          TAG="${{ steps.elrs_release.outputs.tag }}"
          MY_RELEASE="ELRS_${TAG}_${{ env.BAND_NAME }}"
          EXISTING=$(curl -s -o /dev/null -w "%{http_code}" \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/$MY_RELEASE)
          if [ "$EXISTING" == "200" ]; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "release_tag=$MY_RELEASE" >> $GITHUB_OUTPUT
          fi

      - name: Checkout upstream ELRS
        if: steps.check_built.outputs.should_build == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ steps.elrs_release.outputs.tag }}

      - name: Checkout hardware definitions
        if: steps.check_built.outputs.should_build == 'true'
        uses: actions/checkout@v4
        with:
          repository: ExpressLRS/targets
          path: src/hardware

      - name: Set up Python
        if: steps.check_built.outputs.should_build == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        if: steps.check_built.outputs.should_build == 'true'
        run: pip install platformio intelhex

      - name: Create hardware layout files
        if: steps.check_built.outputs.should_build == 'true'
        run: |
          mkdir -p src/hardware/RX src/hardware/TX
          cat > src/hardware/RX/ESP32_E32-900M30S_RX.json << 'EOF'
          {
              "platform": "esp32",
              "product_name": "DIY ESP32 RX (E32-900M30S)",
              "serial_rx": 13,
              "serial_tx": 13,
              "radio_dio0": 26,
              "radio_dio1": 25,
              "radio_miso": 19,
              "radio_mosi": 23,
              "radio_nss": 5,
              "radio_rst": 14,
              "radio_sck": 18,
              "power_rxen": 27,
              "power_txen": 4,
              "power_min": 0,
              "power_high": 2,
              "power_max": 2,
              "power_default": 2,
              "power_control": 0,
              "power_values": [120, 124, 127],
              "led": 22
          }
          EOF
          cat > src/hardware/TX/${{ env.MODULE_NAME }}_TX.json << 'EOF'
          {
              "platform": "esp32",
              "product_name": "DIY E32-900M30S TX",
              "serial_rx": 2,
              "serial_tx": 2,
              "radio_dio0": 26,
              "radio_dio1": 25,
              "radio_miso": 19,
              "radio_mosi": 23,
              "radio_nss": 5,
              "radio_rst": 14,
              "radio_sck": 18,
              "power_rxen": 13,
              "power_txen": 12,
              "power_apc2": 25,
              "power_min": 2,
              "power_high": 4,
              "power_max": 6,
              "power_default": 2,
              "power_control": 3,
              "power_values": [41, 60, 73, 90, 110, 132, 190],
              "led": 22,
              "use_backpack": false,
              "misc_fan_en": 17
          }
          EOF
          cp src/hardware/RX/ESP32_E32-900M30S_RX.json .
          cp src/hardware/TX/${{ env.MODULE_NAME }}_TX.json .

      - name: Register custom hardware in targets.json
        if: steps.check_built.outputs.should_build == 'true'
        run: |
          python3 << 'PYTHON'
          import json
          with open('src/hardware/targets.json', 'r') as f:
              targets = json.load(f)

          if 'diy' not in targets:
              targets['diy'] = {}
          if 'rx' not in targets['diy']:
              targets['diy']['rx'] = {}
          if 'tx' not in targets['diy']:
              targets['diy']['tx'] = {}

          targets['diy']['rx']['esp32_e32_900m30s_eu868'] = {
              "product_name": "DIY ESP32 RX (E32-900M30S EU868)",
              "lua_name": "ESP32 868 RX",
              "layout_file": "ESP32_E32-900M30S_RX.json",
              "upload_methods": ["uart", "wifi"],
              "platform": "esp32",
              "firmware": "Unified_ESP32_900_RX"
          }

          targets['diy']['tx']['esp32_e32_900m30s_eu868'] = {
              "product_name": "DIY ESP32 TX (E32-900M30S EU868)",
              "lua_name": "ESP32 868 TX",
              "layout_file": "E32-900M30S_TX.json",
              "upload_methods": ["uart", "wifi"],
              "platform": "esp32",
              "firmware": "Unified_ESP32_900_TX"
          }

          with open('src/hardware/targets.json', 'w') as f:
              json.dump(targets, f, indent=2)
          PYTHON

      - name: Configure build
        if: steps.check_built.outputs.should_build == 'true'
        working-directory: src
        run: |
          sed -i 's/^-DRegulatory_Domain_.*/#&/' user_defines.txt
          echo "${{ env.REGULATORY_DOMAIN }}" >> user_defines.txt
          echo "-DLOCK_ON_FIRST_CONNECTION" >> user_defines.txt
          echo "-DAUTO_WIFI_ON_INTERVAL=60" >> user_defines.txt

      - name: Build RX firmware (ESP32)
        if: steps.check_built.outputs.should_build == 'true'
        working-directory: src
        run: |
          pio run -e Unified_ESP32_900_RX_via_UART
          cp .pio/build/Unified_ESP32_900_RX_via_UART/firmware.bin \
             ../ELRS_${{ steps.elrs_release.outputs.tag }}_RX_ESP32_${{ env.BAND_NAME }}.bin
          cp .pio/build/Unified_ESP32_900_RX_via_UART/bootloader.bin ../bootloader_rx.bin
          cp .pio/build/Unified_ESP32_900_RX_via_UART/partitions.bin ../partitions_rx.bin
          cp .pio/build/Unified_ESP32_900_RX_via_UART/boot_app0.bin ../boot_app0_rx.bin

      - name: Build TX firmware (ESP32)
        if: steps.check_built.outputs.should_build == 'true'
        working-directory: src
        run: |
          pio run -e Unified_ESP32_900_TX_via_UART
          cp .pio/build/Unified_ESP32_900_TX_via_UART/firmware.bin \
             ../ELRS_${{ steps.elrs_release.outputs.tag }}_TX_ESP32_${{ env.BAND_NAME }}.bin
          cp .pio/build/Unified_ESP32_900_TX_via_UART/bootloader.bin ../bootloader_tx.bin
          cp .pio/build/Unified_ESP32_900_TX_via_UART/partitions.bin ../partitions_tx.bin
          cp .pio/build/Unified_ESP32_900_TX_via_UART/boot_app0.bin ../boot_app0_tx.bin

      - name: Create Release
        if: steps.check_built.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check_built.outputs.release_tag }}
          name: "ELRS ${{ steps.elrs_release.outputs.tag }} for ${{ env.MODULE_NAME }} (${{ env.BAND_NAME }})"
          body: |
            ## Auto-built from ELRS ${{ steps.elrs_release.outputs.tag }}

            Firmware for ${{ env.MODULE_NAME }} module (SX1276, 1W output).

            ### Hardware
            - **RX:** ESP32 (WROOM/DevKit) + ${{ env.MODULE_NAME }}
            - **TX:** ESP32 (WROOM/DevKit) + ${{ env.MODULE_NAME }}

            ### Frequency
            - Band: ${{ env.BAND_NAME }} (863-870MHz)

            ### Flashing RX (ESP32)
            ```bash
            esptool.py --chip esp32 write_flash \
                0x1000 bootloader_rx.bin \
                0x8000 partitions_rx.bin \
                0xe000 boot_app0_rx.bin \
                0x10000 ELRS_*_RX_ESP32_*.bin
            ```

            ### Flashing TX (ESP32)
            ```bash
            esptool.py --chip esp32 write_flash \
                0x1000 bootloader_tx.bin \
                0x8000 partitions_tx.bin \
                0xe000 boot_app0_tx.bin \
                0x10000 ELRS_*_TX_ESP32_*.bin
            ```

            ---
            *Auto-built by GitHub Actions*
          files: |
            bootloader_rx.bin
            partitions_rx.bin
            boot_app0_rx.bin
            ELRS_${{ steps.elrs_release.outputs.tag }}_RX_ESP32_${{ env.BAND_NAME }}.bin
            bootloader_tx.bin
            partitions_tx.bin
            boot_app0_tx.bin
            ELRS_${{ steps.elrs_release.outputs.tag }}_TX_ESP32_${{ env.BAND_NAME }}.bin
            ESP32_E32-900M30S_RX.json
            ${{ env.MODULE_NAME }}_TX.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
